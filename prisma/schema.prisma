generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// COMPANY MODEL (Multi-tenant support)
// ============================================

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  address   String?
  phone     String?
  email     String?
  website   String?
  taxId     String? // NIF/CIF
  currency  String   @default("EUR")
  timezone  String   @default("Europe/Madrid")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users    User[]
  projects Project[]
  clients  Client[]
  leads    Lead[]
  expenses Expense[]
  invoices Invoice[]
  products Product[]
  taxRates TaxRate[]
  quotes   Quote[]
  teams    Team[]
  settings CompanySettings?
  activityLogs ActivityLog[]

  @@index([slug])
}

model User {
  id                String            @id @default(cuid())
  name              String
  email             String            @unique
  image             String?
  passwordHash      String
  role              Role              @default(WORKER)
  department        Department        @default(OTHER)
  companyId         String?
  company           Company?          @relation(fields: [companyId], references: [id])
  dailyWorkHours    Float             @default(8.0)
  isActive          Boolean           @default(true)
  
  // Presence system (Teams-style)
  presenceStatus    PresenceStatus    @default(OFFLINE)
  presenceManual    Boolean           @default(false) // true if manually set
  lastActiveAt      DateTime?         // Last activity timestamp
  presenceExpiresAt DateTime?         // For temporary status duration
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  timeEntries       TimeEntry[]
  assignedTasks     Task[]            @relation("AssignedTasks")
  tasks             Task[]            @relation("TaskAssignees")
  createdTasks      Task[]            @relation("CreatedTasks")
  notifications     Notification[]
  sentNotifications Notification[]    @relation("SentNotifications")
  taskComments      TaskComment[]
  uploadedDocuments Document[]        @relation("UploadedDocuments")
  documentVersions  DocumentVersion[]
  createdFolders    Folder[]
  documentShares    DocumentShare[]
  createdEvents     Event[]
  eventInvitations  EventAttendee[]
  preferences       Json?
  chatMemberships   ChatMember[]      @relation("ChatMemberships")
  authoredMessages  Message[]         @relation("AuthoredMessages")
  assignedLeads     Lead[]
  activityLogs      ActivityLog[]
  expenses          Expense[]
  createdInvoices   Invoice[]
  createdPayments   Payment[]
  savedFilters      SavedFilter[]
  Quote             Quote[]
  
  // New relations for permissions system
  permissions       Permission[]
  managedTeams      Team[]            @relation("TeamManager")
  memberOfTeams     Team[]            @relation("TeamMembers")
  calendarItems     CalendarItem[]

  @@index([companyId])
}

model Project {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  year        Int
  department  Department  @default(OTHER)
  isActive    Boolean     @default(true)
  companyId   String?
  company     Company?    @relation(fields: [companyId], references: [id])
  clientId    String?
  client      Client?     @relation(fields: [clientId], references: [id])
  timeEntries TimeEntry[]
  tasks       Task[]
  documents   Document[]
  folders     Folder[]
  events      Event[]
  Chat        Chat[]
  expenses    Expense[]
  invoices    Invoice[]
  teams       Team[]      @relation("TeamProject")

  @@index([companyId])
  @@index([clientId])
}

model Client {
  id           String          @id @default(cuid())
  name         String
  email        String?
  phone        String?
  companyName  String? // Nombre de la empresa del cliente
  companyId    String? // Tenant owner
  ownerCompany Company?        @relation(fields: [companyId], references: [id])
  address      String?
  industry     String?
  website      String?
  notes        String?         @db.Text
  status       ClientStatus    @default(ACTIVE)
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  projects     Project[]
  contacts     ClientContact[]
  leads        Lead[]
  invoices     Invoice[]
  Quote        Quote[]

  @@index([companyId])
}

model ClientContact {
  id         String   @id @default(cuid())
  clientId   String
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name       String
  email      String?
  phone      String?
  position   String?
  isPrimary  Boolean  @default(false)
  accessCode String? // Added for portal access
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([clientId])
}

model Lead {
  id                String    @id @default(cuid())
  title             String
  description       String?   @db.Text
  value             Decimal   @default(0) @db.Decimal(12, 2)
  currency          String    @default("EUR")
  probability       Int       @default(0)
  expectedCloseDate DateTime?
  stage             LeadStage @default(NEW)

  companyId    String
  ownerCompany Company @relation(fields: [companyId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Quote     Quote[]

  @@index([companyId])
  @@index([clientId])
  @@index([assignedToId])
  @@index([stage])
}

model TimeEntry {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  date      DateTime
  hours     Float
  notes     String?
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, date])
  @@index([projectId])
}

model Task {
  id           String       @id @default(cuid())
  title        String
  description  String?
  status       TaskStatus   @default(PENDING)
  priority     TaskPriority @default(MEDIUM)
  type         TaskType     @default(GENERAL)
  dueDate      DateTime?
  projectId    String?
  assignedToId String?
  createdById  String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  completedAt  DateTime?

  project    Project?      @relation(fields: [projectId], references: [id])
  assignedTo User?         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  assignees  User[]        @relation("TaskAssignees")
  createdBy  User          @relation("CreatedTasks", fields: [createdById], references: [id])
  comments   TaskComment[]

  @@index([assignedToId])
  @@index([createdById])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
}

model TaskComment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  userId    String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user   User  @relation(fields: [userId], references: [id])
  senderId String?
  sender   User? @relation("SentNotifications", fields: [senderId], references: [id])

  @@index([userId, isRead])
  @@index([createdAt])
}

model Document {
  id           String   @id @default(cuid())
  name         String
  description  String?
  fileName     String
  fileSize     Int
  fileType     String
  filePath     String
  version      Int      @default(1)
  projectId    String?
  folderId     String?
  uploadedById String
  isPublic     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project    Project?          @relation(fields: [projectId], references: [id])
  folder     Folder?           @relation(fields: [folderId], references: [id])
  uploadedBy User              @relation("UploadedDocuments", fields: [uploadedById], references: [id])
  versions   DocumentVersion[]
  shares     DocumentShare[]

  @@index([projectId])
  @@index([folderId])
  @@index([uploadedById])
  @@index([createdAt])
}

model DocumentVersion {
  id           String   @id @default(cuid())
  documentId   String
  version      Int
  fileName     String
  filePath     String
  fileSize     Int
  uploadedById String
  changes      String?
  createdAt    DateTime @default(now())

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy User     @relation(fields: [uploadedById], references: [id])

  @@index([documentId])
  @@index([createdAt])
}

model Folder {
  id          String   @id @default(cuid())
  name        String
  description String?
  projectId   String?
  parentId    String?
  createdById String
  createdAt   DateTime @default(now())

  project   Project?   @relation(fields: [projectId], references: [id])
  parent    Folder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  children  Folder[]   @relation("FolderHierarchy")
  createdBy User       @relation(fields: [createdById], references: [id])
  documents Document[]

  @@index([projectId])
  @@index([parentId])
  @@index([createdById])
}

model DocumentShare {
  id              String      @id @default(cuid())
  documentId      String
  sharedWithId    String?
  sharedWithEmail String?
  accessLevel     AccessLevel @default(VIEW)
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sharedWith User?    @relation(fields: [sharedWithId], references: [id])

  @@index([documentId])
  @@index([sharedWithId])
}

enum Role {
  SUPERADMIN
  ADMIN
  MANAGER
  WORKER
  GUEST
}

enum Department {
  CIVIL_DESIGN      // Diseño y Civil
  ELECTRICAL        // Eléctrico
  INSTRUMENTATION   // Instrumentación y Control
  ADMINISTRATION    // Administración
  IT                // Informática
  ECONOMIC          // Económico
  MARKETING         // Marketing
  OTHER             // Otros
}

// Presence status like Microsoft Teams
enum PresenceStatus {
  AVAILABLE         // Disponible (verde)
  BUSY              // Ocupado (rojo)
  DO_NOT_DISTURB    // No molestar (rojo con línea)
  BE_RIGHT_BACK     // Vuelvo enseguida (amarillo)
  AWAY              // Ausente (amarillo)
  OFFLINE           // Desconectado (gris)
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  GENERAL
  PROJECT
  MEETING
  REVIEW
  MAINTENANCE
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_COMPLETED
  TASK_COMMENT
  TASK_DUE_SOON
  HOURS_APPROVED
  PROJECT_ASSIGNED
  SYSTEM
}

enum AccessLevel {
  VIEW
  DOWNLOAD
  EDIT
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  allDay      Boolean   @default(false)
  location    String?
  type        EventType @default(MEETING)
  recurrenceRule String? // ISO 8601 repeating rule pattern or simplified "DAILY", "WEEKLY", "MONTHLY"

  userId    String
  projectId String?

  user    User     @relation(fields: [userId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  attendees EventAttendee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([startDate])
}

model EventAttendee {
  id      String         @id @default(cuid())
  eventId String
  userId  String
  status  AttendeeStatus @default(PENDING)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ============================================
// COMMUNICATION MODULE (Phase 5)
// ============================================

model Chat {
  id        String   @id @default(cuid())
  type      ChatType @default(PROJECT)
  name      String? // For project chats, null for DMs
  image     String? // URL of the chat image
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  messages Message[]
  members  ChatMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

model ChatMember {
  id     String @id @default(cuid())
  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation("ChatMemberships", fields: [userId], references: [id], onDelete: Cascade)

  isFavorite Boolean @default(false)
  role       String  @default("MEMBER") // "ADMIN", "MEMBER"

  lastRead DateTime @default(now())
  joinedAt DateTime @default(now())

  @@unique([chatId, userId])
  @@index([userId])
}

model Message {
  id       String @id @default(cuid())
  content  String @db.Text
  chatId   String
  chat     Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  authorId String
  author   User   @relation("AuthoredMessages", fields: [authorId], references: [id])

  replyToId String?
  replyTo   Message?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("MessageReplies")

  attachments Json? // Array of document IDs or file URLs
  mentions    String[] // Array of user IDs mentioned

  isEdited  Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatId, createdAt])
  @@index([authorId])
}

enum EventType {
  MEETING
  DEADLINE
  REMINDER
  HOLIDAY
  OTHER
}

enum AttendeeStatus {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

enum ChatType {
  PROJECT
  DIRECT
  GROUP
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  companyId  String?
  company    Company? @relation(fields: [companyId], references: [id])
  action     String
  entityType String?
  entityId   String?
  details    String?  @db.Text
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([companyId])
  @@index([createdAt])
  @@index([action])
}

enum LeadStage {
  NEW
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PROSPECT
}

model Expense {
  id          String          @id @default(cuid())
  description String
  amount      Decimal         @db.Decimal(12, 2)
  currency    String          @default("EUR")
  date        DateTime
  category    ExpenseCategory @default(OTHER)

  companyId    String?
  ownerCompany Company? @relation(fields: [companyId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  receiptUrl String?
  status     ExpenseStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([projectId])
  @@index([userId])
}

enum ExpenseCategory {
  TRAVEL
  MEALS
  EQUIPMENT
  SOFTWARE
  OFFICE
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

model SystemSetting {
  key         String  @id
  value       String // JSON encoded value
  description String?
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  managerId   String?
  manager     User?    @relation("TeamManager", fields: [managerId], references: [id])
  members     User[]   @relation("TeamMembers")
  
  // Optional project link
  projectId   String?
  project     Project? @relation("TeamProject", fields: [projectId], references: [id])
  
  // Associated group chat
  chatId      String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([managerId])
  @@index([projectId])
}

// ============================================
// PERMISSION SYSTEM
// ============================================

model Permission {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource  String   // "tasks", "expenses", "invoices", etc.
  action    String   // "create", "read", "update", "delete", "approve"
  granted   Boolean  @default(true) // true = override granted, false = override denied
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, resource, action])
  @@index([userId])
}

model DepartmentPermission {
  id         String     @id @default(cuid())
  department Department // ENGINEERING, ARCHITECTURE, ADMINISTRATION, OTHER
  resource   String     // "tasks", "expenses", "documents", etc.
  action     String     // "create", "read", "update", "delete", "approve", "export"
  granted    Boolean    @default(true) // true = allow, false = deny
  scope      String?    // "all", "own", "department" - null means boolean only
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([department, resource, action])
  @@index([department])
}


model CompanySettings {
  id                 String   @id @default(cuid())
  companyId          String   @unique
  company            Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // SUPERADMIN vetos over this company's ADMIN
  canCreateUsers     Boolean  @default(true)
  canDeleteUsers     Boolean  @default(true)
  canChangeRoles     Boolean  @default(true)
  canAccessInvoicing Boolean  @default(true)
  canAccessReports   Boolean  @default(true)
  canExportData      Boolean  @default(true)
  canViewAuditLogs   Boolean  @default(true)
  canCreateGuests    Boolean  @default(true)
  
  // Enabled modules for this company
  modulesEnabled     String[] @default(["projects", "tasks", "documents", "hours", "expenses", "invoices", "crm", "analytics"])
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// ============================================
// FINANCE MODULE (Invoices & Payments)
// ============================================

model Invoice {
  id      String        @id @default(cuid())
  number  String        @unique // INV-2024-001
  date    DateTime      @default(now())
  dueDate DateTime
  status  InvoiceStatus @default(DRAFT)

  // Multi-tenant
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  // Relations
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  // Amounts (Decimal for financial precision)
  subtotal  Decimal @default(0) @db.Decimal(12, 2)
  taxAmount Decimal @default(0) @db.Decimal(12, 2)
  total     Decimal @default(0) @db.Decimal(12, 2)
  currency  String  @default("EUR")

  // Payment tracking
  paidAmount Decimal @default(0) @db.Decimal(12, 2)
  balance    Decimal @default(0) @db.Decimal(12, 2) // total - paidAmount

  // Metadata
  notes       String? @db.Text
  terms       String? @db.Text
  createdById String
  createdBy   User    @relation(fields: [createdById], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  issuedAt  DateTime? // When status changed to SENT
  paidAt    DateTime? // When fully paid

  // Relations
  items    InvoiceItem[]
  payments Payment[]

  @@index([companyId])
  @@index([clientId])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([number])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2) // Percentage (21 = 21%)

  // Calculated fields (Decimal for precision)
  subtotal  Decimal @db.Decimal(12, 2) // quantity * unitPrice
  taxAmount Decimal @db.Decimal(12, 2) // subtotal * (taxRate / 100)
  total     Decimal @db.Decimal(12, 2) // subtotal + taxAmount

  order Int @default(0) // Display order

  @@index([invoiceId])
}

model Payment {
  id        String        @id @default(cuid())
  amount    Decimal       @db.Decimal(12, 2)
  date      DateTime      @default(now())
  method    PaymentMethod @default(TRANSFER)
  reference String? // Transaction reference
  notes     String?

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([date])
}

enum InvoiceStatus {
  DRAFT // Being created
  SENT // Sent to client
  OVERDUE // Past due date
  PAID // Fully paid
  CANCELLED // Cancelled
  PARTIAL // Partially paid
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  CHEQUE
  OTHER
}

// ============================================
// PRODUCT/SERVICE CATALOG
// ============================================

model Product {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name        String
  description String?
  sku         String? // Product code/SKU
  type        ProductType @default(SERVICE)
  category    String? // Custom category

  price   Decimal  @default(0) @db.Decimal(12, 2)
  cost    Decimal? @db.Decimal(12, 2) // Cost price (for margin calculation)
  taxRate Decimal  @default(21) @db.Decimal(5, 2) // Default IVA %
  unit    String   @default("unidad") // unit, hour, kg, etc.

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([sku])
  @@index([type])
  @@index([isActive])
}

enum ProductType {
  PRODUCT
  SERVICE
}

// ============================================
// TAX RATES CONFIGURATION
// ============================================

model TaxRate {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name        String // "IVA 21%", "IVA Reducido", etc.
  rate        Decimal @db.Decimal(5, 2) // 21, 10, 4, 0
  description String?
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([isDefault])
}

// ============================================
// QUOTES & QUOTE ITEMS (Commercial Flow)
// ============================================

model Quote {
  id         String      @id @default(cuid())
  number     String      @unique
  status     QuoteStatus @default(DRAFT)
  validUntil DateTime

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id])

  // Financial fields (Decimal for precision)
  subtotal  Decimal @default(0) @db.Decimal(12, 2)
  taxAmount Decimal @default(0) @db.Decimal(12, 2)
  total     Decimal @default(0) @db.Decimal(12, 2)

  notes String? @db.Text
  terms String? @db.Text

  items QuoteItem[]

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  sentAt      DateTime?
  acceptedAt  DateTime?
  rejectedAt  DateTime?
  convertedAt DateTime?

  @@index([companyId])
  @@index([clientId])
  @@index([leadId])
  @@index([status])
  @@index([number])
}

model QuoteItem {
  id      String @id @default(cuid())
  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)

  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  order Int @default(0)

  @@index([quoteId])
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

// ============================================
// SAVED FILTERS (for DataTable persistence)
// ============================================

model SavedFilter {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  page      String // "invoices", "tasks", "expenses", etc.
  name      String // "Mis tareas pendientes"
  filters   Json // { status: "PENDING", assignedTo: "me" }
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([page])
}

// ============================================
// HOLIDAYS (Configurable by SUPERADMIN)
// ============================================

model Holiday {
  id        String   @id @default(cuid())
  companyId String?  // null = global for all companies
  date      DateTime @db.Date
  name      String   // "Año Nuevo", "Viernes Santo", etc.
  type      String   @default("NATIONAL") // NATIONAL, REGIONAL, LOCAL, COMPANY
  year      Int      // For quick filtering by year
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, date])
  @@index([companyId])
  @@index([year])
}

// ============================================
// HOURS CONTROL SETTINGS (Configurable by ADMIN)
// ============================================

model HoursControlSettings {
  id                    String   @id @default("default")
  companyId             String?  @unique
  defaultDailyHours     Float    @default(8.0)
  lockAfterDays         Int      @default(30) // Lock editing after N days
  reminderThresholdDays Int      @default(3)  // Remind if N days without entries
  approvalFrequency     String   @default("none") // none, weekly, monthly
  calculationMode       String   @default("laborables") // laborables, imputados
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// CALENDAR ITEMS (Personal quick notes/reminders)
// ============================================

model CalendarItem {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  date        DateTime @db.Date
  allDay      Boolean  @default(true)
  color       String?  @default("#8b5cf6") // Purple
  createdAt   DateTime @default(now())

  @@index([userId, date])
  @@index([date])
}
